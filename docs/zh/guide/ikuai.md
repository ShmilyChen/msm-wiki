# 爱快配置指南

本文档介绍如何在爱快 (iKuai) 路由器上配置 MSM 旁路由，实现 DNS 分流和透明代理。

## 环境说明

**示例网络环境**：
- 爱快路由器 IP: `192.168.1.1`
- MSM 主机 IP: `192.168.1.2`
- 备用 DNS: `223.5.5.5`

::: tip 提示
请根据实际网络环境修改 IP 地址。
:::

## 前置条件

1. ✅ 爱快路由器已连接外网，能够正常上网
2. ✅ MSM 已安装并运行在 `192.168.1.2`
3. ✅ MSM 主机已配置固定 IP 地址

## 配置步骤

### 步骤一：配置静态路由

登录爱快 Web 管理界面，进入 **网络设置 > 静态路由**。

#### 1. 添加 FakeIP 路由（必需）

点击 **添加**，填写以下信息：

- **目标网络**: `28.0.0.0`
- **子网掩码**: `255.0.0.0` (或 CIDR: `/8`)
- **网关**: `192.168.1.2` (MSM 主机 IP)
- **接口**: 选择 LAN 接口
- **备注**: `MSM FakeIP 路由`

点击 **保存**。

#### 2. 添加 Telegram IP 路由（可选）

如果需要确保 Telegram 走代理，添加以下路由：

| 目标网络 | 子网掩码 | 网关 | 备注 |
|---------|---------|------|------|
| 149.154.160.0 | 255.255.252.0 | 192.168.1.2 | Telegram 1 |
| 149.154.164.0 | 255.255.252.0 | 192.168.1.2 | Telegram 2 |
| 149.154.172.0 | 255.255.252.0 | 192.168.1.2 | Telegram 3 |
| 91.108.4.0 | 255.255.252.0 | 192.168.1.2 | Telegram 4 |
| 91.108.8.0 | 255.255.252.0 | 192.168.1.2 | Telegram 5 |
| 91.108.12.0 | 255.255.252.0 | 192.168.1.2 | Telegram 6 |
| 91.108.16.0 | 255.255.252.0 | 192.168.1.2 | Telegram 7 |
| 91.108.20.0 | 255.255.252.0 | 192.168.1.2 | Telegram 8 |
| 91.108.56.0 | 255.255.252.0 | 192.168.1.2 | Telegram 9 |
| 95.161.64.0 | 255.255.252.0 | 192.168.1.2 | Telegram 10 |
| 67.198.55.0 | 255.255.255.0 | 192.168.1.2 | Telegram 11 |
| 109.239.140.0 | 255.255.255.0 | 192.168.1.2 | Telegram 12 |

### 步骤二：配置 DNS

#### 1. 修改路由器 DNS

进入 **网络设置 > 内外网设置 > 外网设置**，找到当前使用的外网接口，点击 **编辑**。

在 **DNS 设置** 中：
- **首选 DNS**: `192.168.1.2` (MSM 主机 IP)
- **备用 DNS**: `223.5.5.5` (可选)

点击 **保存**。

#### 2. 配置 DHCP Server

进入 **网络设置 > DHCP 设置 > DHCP 服务端**，找到 LAN 接口的 DHCP 配置，点击 **编辑**。

在 **DNS 服务器** 中：
- **首选 DNS**: `192.168.1.2` (MSM 主机 IP)
- **备用 DNS**: `223.5.5.5` (可选)

点击 **保存**。

::: tip 租约时间
可以将 DHCP 租约时间设置为较短时间（如 3 分钟），这样当 MSM 故障时，设备可以更快地获取新的 DNS 配置。
:::

### 步骤三：配置健康检查（推荐）

爱快支持健康检查功能，可以监控 MSM 服务状态，故障时自动切换。

进入 **高级应用 > 健康检查**，点击 **添加**。

#### 配置参数

- **名称**: `MSM 健康检查`
- **检查地址**: `1.1.1.1`
- **检查方式**: `ICMP (Ping)`
- **检查间隔**: `30` 秒
- **超时时间**: `5` 秒
- **失败次数**: `3` 次
- **恢复次数**: `3` 次

#### 故障动作

- **故障时**: 修改 DNS 为 `223.5.5.5`
- **恢复时**: 修改 DNS 为 `192.168.1.2`

::: warning 注意
爱快的健康检查功能可能因版本而异，部分版本可能不支持自动修改 DNS。如果不支持，可以使用脚本实现。
:::

## 配置验证

### 1. 检查静态路由

进入 **网络设置 > 静态路由**，确认 `28.0.0.0/8` 路由已添加且状态为 **启用**。

### 2. 检查 DNS 设置

进入 **网络设置 > 内外网设置 > 外网设置**，确认 DNS 已设置为 `192.168.1.2`。

### 3. 测试 DNS 解析

在客户端设备上：

**Windows**:
```cmd
nslookup google.com
```

**Linux/macOS**:
```bash
dig google.com
```

应该返回 28.0.0.0/8 网段的 IP 地址。

### 4. 测试代理

在白名单设备上访问 Google，应该能够正常访问。

## 故障排查

### 问题 1: DNS 解析失败

**症状**: 客户端无法解析域名

**排查步骤**:
1. 检查 MSM 服务是否运行
2. 检查爱快 DNS 设置是否正确
3. 检查客户端是否获取到正确的 DNS（`ipconfig /all` 或 `cat /etc/resolv.conf`）
4. 尝试手动指定 DNS 为 `192.168.1.2` 测试

### 问题 2: 无法访问国外网站

**症状**: 客户端可以解析域名，但无法访问国外网站

**排查步骤**:
1. 检查静态路由是否配置正确
2. 检查客户端 IP 是否在 MSM 白名单中
3. 检查 SingBox/Mihomo 是否运行
4. 检查代理配置是否正确

### 问题 3: 国内网站访问慢

**症状**: 访问百度等国内网站速度慢

**可能原因**:
- MosDNS 配置问题，国内域名没有正确分流
- 国内 DNS 上游配置不正确

**解决方法**:
1. 检查 MosDNS 配置文件
2. 确认国内 DNS 上游设置为国内 DNS（如 223.5.5.5）
3. 清理 DNS 缓存

## 高级配置

### 1. 配置 DNS 缓存

爱快默认启用 DNS 缓存，可以在 **网络设置 > DNS 加速** 中配置：

- **启用 DNS 缓存**: ✅ 勾选
- **缓存时间**: `3600` 秒（1 小时）

### 2. 配置流控规则

如果需要限制特定设备的流量，可以在 **流控分流 > 流控规则** 中配置。

### 3. 配置端口转发

如果需要从外网访问 MSM 管理界面，可以在 **高级应用 > 端口映射** 中配置端口转发。

::: warning 安全提示
不建议将 MSM 管理界面暴露到公网，如需远程访问，建议使用 VPN。
:::

## 配置截图

::: tip 提示
由于爱快界面可能因版本而异，以下截图仅供参考。
:::

### 静态路由配置

![爱快静态路由](./images/ikuai-route.png)

### DNS 配置

![爱快 DNS 配置](./images/ikuai-dns.png)

### DHCP 配置

![爱快 DHCP 配置](./images/ikuai-dhcp.png)

## 下一步

- [设备管理](/zh/guide/device-management) - 配置设备白名单
- [基础配置](/zh/guide/basic-config) - MSM 基础配置
- [常见问题](/zh/faq/) - 故障排查
