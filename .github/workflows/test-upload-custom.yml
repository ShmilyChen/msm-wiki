name: 测试自定义服务器上传

on:
  workflow_dispatch:
    inputs:
      version:
        description: '测试版本号，将写入 .version 并作为目录名'
        required: false
        default: '0.0.0-test'
        type: string

jobs:
  upload-test:
    name: 自定义上传测试
    runs-on: ubuntu-24.04
    steps:
      - name: 准备测试文件
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version || '0.0.0-test' }}"
          mkdir -p upload/"${VERSION}"
          printf "%s\n" "${VERSION}" > upload/.version
          # 生成一个小型占位包，验证传输逻辑
          echo "hello ${VERSION}" > upload/${VERSION}/msm-${VERSION}-test.txt
          tar -czf upload/${VERSION}/msm-${VERSION}-test.tar.gz -C upload/${VERSION} msm-${VERSION}-test.txt
          rm upload/${VERSION}/msm-${VERSION}-test.txt
          ls -lh upload upload/"${VERSION}"

      - name: 安装 sshpass 与 rsync
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass rsync

      - name: 上传到自定义服务器
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_HOST }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          SERVER_TARGET: ${{ secrets.DEPLOY_TARGET_PATH }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${SERVER_HOST}" ] || [ -z "${SERVER_USER}" ] || [ -z "${SERVER_PASSWORD}" ] || [ -z "${SERVER_TARGET}" ]; then
            echo "服务器信息未配置(DEPLOY_SERVER_* secrets 缺失)，跳过上传"
            exit 0
          fi

          VERSION="${{ inputs.version || '0.0.0-test' }}"
          TARGET="${SERVER_TARGET%/}"
          RSYNC_SSH="ssh -o StrictHostKeyChecking=no"

          sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no "${SERVER_USER}@${SERVER_HOST}" "mkdir -p \"${TARGET}\" \"${TARGET}/${VERSION}\""

          sshpass -p "${SERVER_PASSWORD}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH}" --rsync-path="mkdir -p \"${TARGET}\" && rsync" upload/.version "${SERVER_USER}@${SERVER_HOST}:${TARGET}/"
          sshpass -p "${SERVER_PASSWORD}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH}" --rsync-path="mkdir -p \"${TARGET}/${VERSION}\" && rsync" upload/${VERSION}/ "${SERVER_USER}@${SERVER_HOST}:${TARGET}/${VERSION}/"

          echo "✅ 测试上传完成: ${SERVER_HOST}:${TARGET}/${VERSION}/"

